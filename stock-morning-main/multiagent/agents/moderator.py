"""
ì¤‘ì¬ì(Moderator) ì—ì´ì „íŠ¸
- 4ëª… ì „ë¬¸ê°€ í† ë¡ ì„ ì •ë¦¬í•˜ê³  ìŸì ì„ ë„ì¶œ
- ì¶”ê°€ í† ë¡  í•„ìš” ì—¬ë¶€ íŒë‹¨
- ë°ì´í„° ê¸°ë°˜ ë…¼ì˜ ìœ ë„
"""

from __future__ import annotations

from typing import Dict, Any, List
from multiagent.services import AgentToolkit


class Moderator:
    """í† ë¡  ì¤‘ì¬ì - ìŸì  ì •ë¦¬ ë° ì¶”ê°€ í† ë¡  ìœ ë„"""
    
    def __init__(self, toolkit: AgentToolkit):
        self.toolkit = toolkit
        self.name = "Moderator"
        self.role = "í† ë¡  ì¤‘ì¬ì"
    
    def analyze_round(
        self,
        ticker: str,
        fundamental: str,
        risk: str,
        growth: str,
        sentiment: str,
        round_number: int,
        previous_guidance: List[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """
        ë¼ìš´ë“œ ë¶„ì„ í›„ ìŸì  ì •ë¦¬ ë° ì¶”ê°€ í† ë¡  í•„ìš” ì—¬ë¶€ íŒë‹¨
        
        Returns:
            {
                "needs_more_debate": bool,
                "key_agreements": List[str],
                "key_disagreements": List[str],
                "guidance_for_next_round": str,
                "summary": str
            }
        """
        # ì´ì „ ê°€ì´ë“œ ì •ë¦¬
        previous_guidance_text = ""
        if previous_guidance:
            lines = []
            for pg in previous_guidance:
                round_num = pg.get("round", 0)
                guidance = pg.get("guidance", {})
                lines.append(f"Round {round_num}ì— ìš”ì²­í•œ ë‚´ìš©:")
                for expert, guide in guidance.items():
                    lines.append(f"  - {expert}: {guide}")
            previous_guidance_text = "\n".join(lines)
        
        prompt = f"""ë‹¹ì‹ ì€ 4ëª…ì˜ íˆ¬ì ì „ë¬¸ê°€ í† ë¡ ì„ ì¤‘ì¬í•˜ëŠ” **í† ë¡  ì¤‘ì¬ì**ì…ë‹ˆë‹¤.
ì•„ë˜ëŠ” {ticker}ì— ëŒ€í•œ Round {round_number} í† ë¡  ë‚´ìš©ì…ë‹ˆë‹¤.

---
**ğŸ’¼ Fundamental Analyst (ê°€ì¹˜íˆ¬ì ì „ë¬¸ê°€):**
{fundamental}

**âš ï¸ Risk Manager (ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ë¬¸ê°€):**
{risk}

**ğŸš€ Growth Catalyst Hunter (ì„±ì¥ì£¼ ì „ë¬¸ê°€):**
{growth}

**ğŸ“Š Market Sentiment Analyst (ì‹œì¥ ì‹¬ë¦¬ ì „ë¬¸ê°€):**
{sentiment}
---

**ì´ì „ ë¼ìš´ë“œì—ì„œ ì´ë¯¸ ìš”ì²­í•œ ë‚´ìš©:**
{previous_guidance_text if previous_guidance_text else "ì—†ìŒ (ì²« ë¼ìš´ë“œ)"}

**ë‹¹ì‹ ì˜ ì„ë¬´:**

1. **í•µì‹¬ í•©ì˜ì ** (ë™ì˜í•˜ëŠ” ë¶€ë¶„):
   - 4ëª… ì¤‘ 3ëª… ì´ìƒì´ ë™ì˜í•˜ëŠ” ì£¼ì¥ì„ ì •ë¦¬í•˜ì„¸ìš”.
   - ê° í•©ì˜ì ì— ì–´ë–¤ ì „ë¬¸ê°€ë“¤ì´ ë™ì˜í•˜ëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”.

2. **í•µì‹¬ ìŸì ** (ì˜ê²¬ì´ ê°ˆë¦¬ëŠ” ë¶€ë¶„):
   - ì „ë¬¸ê°€ë“¤ ê°„ ì˜ê²¬ì´ ì¶©ëŒí•˜ëŠ” í•µì‹¬ ì´ìŠˆë¥¼ ì •ë¦¬í•˜ì„¸ìš”.
   - ë‹¨ìˆœí•œ í‘œí˜„ ì°¨ì´ê°€ ì•„ë‹Œ, ê²°ë¡ ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì‹¤ì§ˆì  ìŸì ë§Œ ì¶”ì¶œí•˜ì„¸ìš”.

3. **ì¶”ê°€ í† ë¡  í•„ìš” ì—¬ë¶€ íŒë‹¨**:
   - "ì˜ˆ" ë˜ëŠ” "ì•„ë‹ˆì˜¤"ë¡œ ë‹µë³€
   - ì´ìœ : ì™œ ì¶”ê°€ í† ë¡ ì´ í•„ìš”í•œì§€/ë¶ˆí•„ìš”í•œì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…

4. **ë‹¤ìŒ ë¼ìš´ë“œ ê°€ì´ë“œ** (ì¶”ê°€ í† ë¡  í•„ìš” ì‹œ):
   - ê° ì „ë¬¸ê°€ì—ê²Œ ì–´ë–¤ ë°ì´í„°/ê·¼ê±°ë¥¼ ë” ì œì‹œí•´ì•¼ í•˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ìš”ì²­
   - **âš ï¸ ì¤‘ìš”: ì´ì „ì— ì´ë¯¸ ìš”ì²­í•˜ê³  ë‹µë³€ë°›ì€ ë‚´ìš©ì€ ë‹¤ì‹œ ë¬»ì§€ ë§ˆì„¸ìš”!**
   - **ìƒˆë¡œìš´ ìŸì ì´ë‚˜ ì•„ì§ í•´ê²°ë˜ì§€ ì•Šì€ ë¶€ë¶„ì— ëŒ€í•´ì„œë§Œ ìš”ì²­í•˜ì„¸ìš”**
   - ì˜ˆ: "Fundamental AnalystëŠ” FCF ìˆ˜ì¹˜ë¥¼ ë“¤ì–´ ë°¸ë¥˜ì—ì´ì…˜ ì£¼ì¥ì„ ë’·ë°›ì¹¨í•˜ì„¸ìš”"
   - ì˜ˆ: "Risk ManagerëŠ” êµ¬ì²´ì ì¸ ê·œì œ ì‚¬ë¡€ë‚˜ ì†Œì†¡ í˜„í™©ì„ ì œì‹œí•˜ì„¸ìš”"

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”:
```json
{{
  "needs_more_debate": true ë˜ëŠ” false,
  "reason": "ì¶”ê°€ í† ë¡ ì´ í•„ìš”í•œ/ë¶ˆí•„ìš”í•œ ì´ìœ ",
  "key_agreements": [
    "í•©ì˜ì  1: ì„¤ëª… (ë™ì˜ ì „ë¬¸ê°€: Fundamental, Growth, Sentiment)",
    "í•©ì˜ì  2: ì„¤ëª… (ë™ì˜ ì „ë¬¸ê°€: ì „ì›)"
  ],
  "key_disagreements": [
    "ìŸì  1: Fundamentalì€ Aë¼ê³  ì£¼ì¥í•˜ë‚˜ RiskëŠ” Bë¼ê³  ì£¼ì¥",
    "ìŸì  2: Growthì™€ Sentimentì˜ ë‹¨ê¸° ì „ë§ ì°¨ì´"
  ],
  "guidance": {{
    "fundamental": "Fundamental Analystì—ê²Œ ìš”ì²­í•  ìƒˆë¡œìš´ ë‚´ìš©",
    "risk": "Risk Managerì—ê²Œ ìš”ì²­í•  ìƒˆë¡œìš´ ë‚´ìš©",
    "growth": "Growth Analystì—ê²Œ ìš”ì²­í•  ìƒˆë¡œìš´ ë‚´ìš©",
    "sentiment": "Sentiment Analystì—ê²Œ ìš”ì²­í•  ìƒˆë¡œìš´ ë‚´ìš©"
  }}
}}
```

**ì¤‘ìš”: ë°˜ë“œì‹œ ìœ„ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.**
"""
        
        # JSON í˜•ì‹ ì‘ë‹µ ë³´ì¥ (response_format ì‚¬ìš©)
        result = self.toolkit.chat_json(prompt)
        
        # ê²°ê³¼ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
        if not result:
            return {
                "needs_more_debate": round_number < 2,
                "reason": "JSON íŒŒì‹± ì‹¤íŒ¨ë¡œ ê¸°ë³¸ ì§„í–‰",
                "key_agreements": [],
                "key_disagreements": [],
                "guidance": {
                    "fundamental": "ë°ì´í„° ê¸°ë°˜ ê·¼ê±°ë¥¼ ë” ì œì‹œí•˜ì„¸ìš”",
                    "risk": "êµ¬ì²´ì ì¸ ë¦¬ìŠ¤í¬ ìˆ˜ì¹˜ë¥¼ ì œì‹œí•˜ì„¸ìš”",
                    "growth": "ì„±ì¥ ì´‰ë§¤ì˜ ì‹¤í˜„ ê°€ëŠ¥ì„±ì„ í‰ê°€í•˜ì„¸ìš”",
                    "sentiment": "ì‹œì¥ ì‹¬ë¦¬ì˜ ê·¼ê±°ë¥¼ ì œì‹œí•˜ì„¸ìš”"
                }
            }
        
        # í•„ìˆ˜ í•„ë“œ í™•ì¸ ë° ê¸°ë³¸ê°’ ë³´ì™„
        result.setdefault("needs_more_debate", round_number < 2)
        result.setdefault("reason", "")
        result.setdefault("key_agreements", [])
        result.setdefault("key_disagreements", [])
        result.setdefault("guidance", {})
        
        return result
    
    def generate_final_summary(
        self,
        ticker: str,
        all_rounds: List[Dict],
        final_agreements: List[str],
        final_disagreements: List[str]
    ) -> str:
        """ìµœì¢… í† ë¡  ìš”ì•½ ìƒì„± (ì ìˆ˜ ì—†ì´ ê·¼ê±° ê¸°ë°˜)"""
        
        rounds_text = ""
        for r in all_rounds:
            rounds_text += f"\n=== Round {r.get('round', '?')} ===\n"
            rounds_text += f"Fundamental: {r.get('fundamental', '')[:500]}...\n"
            rounds_text += f"Risk: {r.get('risk', '')[:500]}...\n"
            rounds_text += f"Growth: {r.get('growth', '')[:500]}...\n"
            rounds_text += f"Sentiment: {r.get('sentiment', '')[:500]}...\n"
        
        prompt = f"""ë‹¹ì‹ ì€ íˆ¬ì ë¶„ì„ íŒŸìºìŠ¤íŠ¸ ì§„í–‰ìì…ë‹ˆë‹¤.

**ë¶„ì„ ëŒ€ìƒ:** {ticker}

**í† ë¡  ê¸°ë¡:**
{rounds_text}

**ì „ë¬¸ê°€ í•©ì˜ì :**
{chr(10).join(f'â€¢ {a}' for a in final_agreements) if final_agreements else 'â€¢ ì—†ìŒ'}

**ë¯¸í•´ê²° ìŸì :**
{chr(10).join(f'â€¢ {d}' for d in final_disagreements) if final_disagreements else 'â€¢ ì—†ìŒ'}

---

**ì¶œë ¥ í˜•ì‹:**

## 1. íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸ (ë§¨ ìœ„ì— ì‘ì„±)

SCRIPT_EXAMPLE.md í˜•ì‹ì²˜ëŸ¼ **ìì—°ìŠ¤ëŸ¬ìš´ ì¤„ê¸€**ë¡œ 4-6ë¬¸ë‹¨ì„ ì‘ì„±í•˜ì„¸ìš”.

**ê·œì¹™:**
- "Fundamental ì „ë¬¸ê°€", "Risk Manager", "Growth", "Sentiment" ê°™ì€ **ì „ë¬¸ê°€ ì—­í• ëª…ì€ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€**
- ëŒ€ì‹  ì‹¤ì œ **ë‰´ìŠ¤ ë‚´ìš©**ê³¼ **SEC ê³µì‹œ ë°ì´í„°**ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ 
- ë§ˆì¹˜ ì‹¤ì œ ë‰´ìŠ¤ ì§„í–‰ìê°€ ë§í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±
- ëª¨ë“  ìˆ˜ì¹˜ì™€ ë‚ ì§œëŠ” êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œ (ì˜ˆ: "2025-10-30 ì œì¶œ 10-Qì— ë”°ë¥´ë©´", "12ì›” 23ì¼ ë‰´ìŠ¤ì—ì„œ")

**ì˜ˆì‹œ:**
"ì˜¤ëŠ˜ ë¶„ì„í•œ êµ¬ê¸€(Alphabet Inc.)ì— ëŒ€í•´ ìµœì¢… ê²°ë¡ ì„ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì €í¬ëŠ” ì´ ì¢…ëª©ì— ëŒ€í•´ 'ë§¤ìˆ˜' ì˜ê²¬ì„ ì œì‹œí•©ë‹ˆë‹¤.

ìµœê·¼ ë°œí‘œëœ 10-Q ê³µì‹œ(2025-10-30 ì œì¶œ)ì— ë”°ë¥´ë©´ ì˜ì—…ì´ìµë¥ ì´ 30%ë¥¼ ìœ ì§€í•˜ê³  ìˆê³  ì•½ 480ì–µ ë‹¬ëŸ¬ì˜ í˜„ê¸ˆíë¦„ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ë˜í•œ 12ì›” 23ì¼ ë³´ë„ëœ ë‰´ìŠ¤ì—ì„œëŠ” AI ê²½ìŸë ¥ì´ í¬ê²Œ íšŒë³µë˜ì—ˆë‹¤ëŠ” ë‚´ìš©ì´ ìˆì—ˆìŠµë‹ˆë‹¤. Anthropicì´ Google AI ì¹©ì„ ìµœëŒ€ 100ë§Œ ê°œ ê·œëª¨ë¡œ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤ëŠ” ì ì´ ì£¼ëª©ë©ë‹ˆë‹¤.

í•œí¸ ê·œì œ ë¦¬ìŠ¤í¬ì— ëŒ€í•´ì„œëŠ” ì˜ê²¬ì´ ì—‡ê°ˆë ¸ìŠµë‹ˆë‹¤. ë¯¸êµ­ ë²•ë¬´ë¶€ì˜ ë°˜ë…ì  ì†Œì†¡ì´ ì§„í–‰ ì¤‘ì´ë¼ ì¥ê¸°ì ìœ¼ë¡œ ê²€ìƒ‰ ì‚¬ì—…ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤ëŠ” ìš°ë ¤ë„ ìˆì—ˆì§€ë§Œ, 10-Q ê³µì‹œë¥¼ ë³´ë©´ ë²•ì  ì¶©ë‹¹ê¸ˆì´ í¬ê²Œ ì¦ê°€í•˜ì§€ ì•Šì•„ ì‹¤ì œ ì¶©ê²©ì€ ì œí•œì ì¼ ê²ƒì´ë¼ëŠ” ì‹œê°ë„ ìˆì—ˆìŠµë‹ˆë‹¤.

êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íšì€ ì´ë ‡ìŠµë‹ˆë‹¤. ì´ë²ˆ ì£¼ 310ë‹¬ëŸ¬ì—ì„œ 320ë‹¬ëŸ¬ êµ¬ê°„ì—ì„œ í¬íŠ¸í´ë¦¬ì˜¤ì˜ 5%ë¥¼ 1ì°¨ ë§¤ìˆ˜í•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤..."

---

## 2. êµ¬ì¡°í™”ëœ ë¶„ì„ (ì¤„ê¸€ ì•„ë˜ì— ì‘ì„±)

**ê²°ë¡ **: ìµœì¢… íˆ¬ì ì•¡ì…˜ (BUY/HOLD/SELL) + í¬ì§€ì…˜ ë¹„ì¤‘

**ë§¤ìˆ˜/ë§¤ë„ ê·¼ê±° (3-4ê°€ì§€)**:
- ê° ê·¼ê±°ì— **ë‚ ì§œì™€ ì¶œì²˜**ë¥¼ ë°˜ë“œì‹œ í¬í•¨
- ì˜ˆ: "2025-10-30 ì œì¶œ 10-Qì— ë”°ë¥´ë©´ FCF 480ì–µ ë‹¬ëŸ¬ ìœ ì§€"

**ì£¼ìš” ë¦¬ìŠ¤í¬ (2-3ê°€ì§€)**:
- íˆ¬ì ì‹œ ê³ ë ¤í•´ì•¼ í•  ìœ„í—˜ ìš”ì†Œ

**ë¯¸í•´ê²° ìŸì ì— ëŒ€í•œ íŒì •**:
- ì˜ê²¬ì´ ê°ˆë¦° ìŸì ì— ëŒ€í•´ ì–´ëŠ ìª½ì´ ë” íƒ€ë‹¹í•œì§€, ë˜ëŠ” ì ˆì¶©ì•ˆ ì œì‹œ

**ì‹¤í–‰ ì „ëµ**:
- ì¦‰ì‹œ í–‰ë™: "ì´ë²ˆ ì£¼ $310-320 êµ¬ê°„ì—ì„œ 5% ë§¤ìˆ˜"
- ë‹¨ê¸° ì „ëµ: "3ê°œì›” ë‚´ Cloud YoY >25% ì‹œ 3% ì¶”ê°€ ë§¤ìˆ˜"
- ì¥ê¸° ì „ëµ: "ëª©í‘œê°€ $380, ì´ í¬ì§€ì…˜ 10%"

---

## 3. JSON (ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€)

```json
{{
  "action": "BUY/HOLD/SELL",
  "position_size": 0-20 ì •ìˆ˜,
  "debate_summary": "í•µì‹¬ ë¶„ì„ ìš”ì•½ 1-2ë¬¸ì¥ (ì „ë¬¸ê°€ ì—­í• ëª… ì‚¬ìš© ê¸ˆì§€)",
  "buy_reasons": ["ê·¼ê±°1 (ì¶œì²˜, ë‚ ì§œ)", "ê·¼ê±°2 (ì¶œì²˜, ë‚ ì§œ)"],
  "risk_factors": ["ë¦¬ìŠ¤í¬1", "ë¦¬ìŠ¤í¬2"],
  "moderator_rulings": ["ìŸì 1 íŒì •", "ìŸì 2 íŒì •"],
  "immediate_action": "ì´ë²ˆ ì£¼ $XXX-XXX êµ¬ê°„ì—ì„œ Y% ë§¤ìˆ˜",
  "short_term_strategy": "Nê°œì›” ë‚´ [ì¡°ê±´] ì‹œ Y% ì¶”ê°€ ë§¤ìˆ˜",
  "long_term_strategy": "ëª©í‘œê°€ $XXX, ì´ í¬ì§€ì…˜ Y%ê¹Œì§€ í™•ëŒ€"
}}
```
"""
        
        return self.toolkit.summarize("", prompt)

